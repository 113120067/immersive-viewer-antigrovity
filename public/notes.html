<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>我的筆記</title>
  <script src="https://ircdname.azureedge.net/immersivereadersdk/immersive-reader-sdk.1.4.0.js"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, Roboto, "Noto Sans CJK TC", Arial;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
    }
    nav { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #ddd; }
    nav a { margin-right: 16px; text-decoration: none; color: #0070f3; }
    nav a:hover { text-decoration: underline; }
    h1 { margin-bottom: 8px; }
    .user-info { margin-bottom: 16px; font-size: 14px; color: #666; }
    button {
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #bbb;
      background: #f6f6f6;
      cursor: pointer;
      margin-right: 8px;
    }
    button:hover { background: #e6e6e6; }
    .btn-primary {
      background: #0070f3;
      color: white;
      border-color: #0070f3;
    }
    .btn-primary:hover { background: #0051cc; }
    .btn-danger {
      background: #e00;
      color: white;
      border-color: #e00;
    }
    .btn-danger:hover { background: #c00; }
    .note-form {
      background: #f9f9f9;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 24px;
      border: 1px solid #ddd;
    }
    .note-form input, .note-form textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    .note-form textarea {
      min-height: 120px;
      font-family: inherit;
      resize: vertical;
    }
    .notes-list {
      margin-top: 24px;
    }
    .note-item {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .note-item h3 {
      margin: 0 0 8px 0;
      font-size: 18px;
    }
    .note-item .note-content {
      color: #333;
      line-height: 1.6;
      margin-bottom: 12px;
      white-space: pre-wrap;
    }
    .note-item .note-meta {
      font-size: 12px;
      color: #999;
      margin-bottom: 12px;
    }
    .note-item .note-actions button {
      font-size: 13px;
      padding: 6px 10px;
    }
    .links { margin-top: 24px; padding-top: 16px; border-top: 1px solid #ddd; }
    .links a { margin-right: 16px; }
    .loading { color: #666; font-style: italic; }
    .error { color: red; background: #fee; padding: 12px; border-radius: 4px; margin-bottom: 16px; }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a> |
    <a href="/options">Options</a> |
    <a href="/upload">Upload</a> |
    <a href="/upload-vocab">Vocabulary</a> |
    <a href="/classroom">Classroom</a> |
    <a id="nav-login" href="/login.html">Login</a>
    <a id="nav-notes" href="/notes.html" style="display:none;margin-left:8px;">My Notes</a>
  </nav>
  <h1>我的筆記</h1>
  <div class="user-info" id="user-info">載入中...</div>

  <div id="auth-required" style="display:none;">
    <p>請先<a href="/login.html">登入</a>以使用筆記功能。</p>
  </div>

  <div id="notes-container" style="display:none;">
    <div class="note-form">
      <h2 style="margin-top:0;" id="form-title">新增筆記</h2>
      <input type="text" id="note-title" placeholder="標題" />
      <textarea id="note-content" placeholder="內容"></textarea>
      <button class="btn-primary" id="btn-save">儲存</button>
      <button id="btn-cancel" style="display:none;">取消</button>
    </div>

    <div class="notes-list">
      <h2>所有筆記</h2>
      <div id="notes-list-container" class="loading">載入筆記中...</div>
    </div>
  </div>

  <div class="links">
    <a href="/upload-vocab">回到 Upload Vocabulary</a> |
    <a href="/login.html">登入/登出</a>
  </div>

  <script type="module">
    import { initialize, onAuthStateChanged } from '/firebase-client.js';
    import { createNote, updateNote, deleteNote, onUserNotesChanged } from '/firebase-notes.js';

    await initialize();

    const userInfo = document.getElementById('user-info');
    const authRequired = document.getElementById('auth-required');
    const notesContainer = document.getElementById('notes-container');
    const noteTitle = document.getElementById('note-title');
    const noteContent = document.getElementById('note-content');
    const btnSave = document.getElementById('btn-save');
    const btnCancel = document.getElementById('btn-cancel');
    const notesListContainer = document.getElementById('notes-list-container');
    const formTitle = document.getElementById('form-title');

    let currentUser = null;
    let unsubscribe = null;
    let editingNoteId = null;

    onAuthStateChanged(async user => {
      currentUser = user;
      if (user) {
        userInfo.textContent = `已登入：${user.email}`;
        authRequired.style.display = 'none';
        notesContainer.style.display = 'block';

        // Subscribe to notes updates
        try {
          if (unsubscribe) unsubscribe();
          unsubscribe = await onUserNotesChanged(displayNotes);
        } catch (err) {
          console.error('Failed to subscribe to notes:', err);
          notesListContainer.innerHTML = `<div class="error">無法載入筆記：${err.message}</div>`;
        }
      } else {
        userInfo.textContent = '未登入';
        authRequired.style.display = 'block';
        notesContainer.style.display = 'none';
        if (unsubscribe) {
          unsubscribe();
          unsubscribe = null;
        }
      }
    });

    function displayNotes(notes) {
      if (notes.length === 0) {
        notesListContainer.innerHTML = '<p class="loading">尚無筆記</p>';
        return;
      }

      notesListContainer.innerHTML = notes.map(note => `
        <div class="note-item" data-id="${note.id}">
          <h3>${escapeHtml(note.title || '(無標題)')}</h3>
          <div class="note-content">${escapeHtml(note.content || '')}</div>
          <div class="note-meta">
            建立：${formatDate(note.createdAt)} | 更新：${formatDate(note.updatedAt)}
          </div>
          <div class="note-actions">
              <button class="btn-edit" data-id="${note.id}">編輯</button>
              <button class="btn-primary btn-read" data-id="${note.id}">閱讀</button>
              <button class="btn-danger btn-delete" data-id="${note.id}">刪除</button>
          </div>
        </div>
      `).join('');

      // Add event listeners
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => editNote(btn.dataset.id, notes));
      });
      document.querySelectorAll('.btn-delete').forEach(btn => {
        btn.addEventListener('click', () => confirmDeleteNote(btn.dataset.id));
      });
        // Read with Immersive Reader
        document.querySelectorAll('.btn-read').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            const note = notes.find(n => n.id === id);
            if (!note) return;
            try {
              btn.disabled = true;
              btn.textContent = '開啟中...';
              await readNoteInImmersiveReader(note);
            } catch (err) {
              console.error('Immersive Reader error:', err);
              alert('無法開啟 Immersive Reader：' + (err.message || err));
            } finally {
              btn.disabled = false;
              btn.textContent = '閱讀';
            }
          });
        });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'N/A';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      return date.toLocaleString('zh-TW');
    }

    function editNote(noteId, notes) {
      const note = notes.find(n => n.id === noteId);
      if (!note) return;

      editingNoteId = noteId;
      noteTitle.value = note.title || '';
      noteContent.value = note.content || '';
      formTitle.textContent = '編輯筆記';
      btnSave.textContent = '更新';
      btnCancel.style.display = 'inline-block';
      noteTitle.focus();
    }

    function cancelEdit() {
      editingNoteId = null;
      noteTitle.value = '';
      noteContent.value = '';
      formTitle.textContent = '新增筆記';
      btnSave.textContent = '儲存';
      btnCancel.style.display = 'none';
    }

    async function confirmDeleteNote(noteId) {
      if (!confirm('確定要刪除這則筆記嗎？')) return;
      
      try {
        await deleteNote(noteId);
        if (editingNoteId === noteId) {
          cancelEdit();
        }
      } catch (err) {
        console.error('Delete error:', err);
        alert('刪除失敗：' + (err.message || err));
      }
    }

    btnSave.addEventListener('click', async () => {
      const title = noteTitle.value.trim();
      const content = noteContent.value.trim();

      if (!title && !content) {
        alert('請至少輸入標題或內容');
        return;
      }

      try {
        btnSave.disabled = true;
        btnSave.textContent = '儲存中...';

        if (editingNoteId) {
          await updateNote(editingNoteId, { title, content });
        } else {
          await createNote(title, content);
        }

        cancelEdit();
      } catch (err) {
        console.error('Save error:', err);
        alert('儲存失敗：' + (err.message || err));
      } finally {
        btnSave.disabled = false;
        btnSave.textContent = editingNoteId ? '更新' : '儲存';
      }
    });

    btnCancel.addEventListener('click', cancelEdit);

    // Allow enter to submit in title field
    noteTitle.addEventListener('keypress', e => {
      if (e.key === 'Enter') {
        e.preventDefault();
        btnSave.click();
      }
    });

    // --- Immersive Reader integration (using modular client) ---
    import { launchFromText } from '/js/immersive-reader-client.js';

    async function readNoteInImmersiveReader(note) {
      await launchFromText(note.title || 'Note', note.content || '', note.lang || 'zh-Hant', { uiLang: 'zh-Hant' });
    }
  </script>
</body>
</html>
