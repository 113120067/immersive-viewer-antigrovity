<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>登入</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, Roboto, "Noto Sans CJK TC", Arial; 
      padding: 20px; 
      max-width: 500px;
      margin: 0 auto;
    }
    .form-group {
      margin-bottom: 12px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }
    input[type="email"], input[type="password"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button { 
      padding: 8px 12px; 
      border-radius: 6px; 
      border: 1px solid #bbb; 
      background: #f6f6f6; 
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    button:hover {
      background: #e6e6e6;
    }
    .button-group {
      margin-top: 16px;
    }
    #user-info {
      margin-bottom: 16px;
      padding: 12px;
      background: #f0f0f0;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <nav>
    <a href="/">Home</a> |
    <a href="/options">Options</a> |
    <a href="/upload">Upload</a> |
    <a href="/upload-vocab">Vocabulary</a> |
    <a href="/classroom">Classroom</a> |
    <a id="nav-login" href="/login.html">Login</a>
    <a id="nav-notes" href="/notes.html" style="display:none;margin-left:8px;">My Notes</a>
  </nav>

  <script type="module">
    import { initialize, onAuthStateChanged } from '/firebase-client.js';
    (async () => {
      try { await initialize(); } catch(e) { /* ignore if not configured */ }
      onAuthStateChanged(user => {
        const loginEl = document.getElementById('nav-login');
        const notesEl = document.getElementById('nav-notes');
        if (user) {
          if (loginEl) loginEl.style.display = 'none';
          if (notesEl) notesEl.style.display = '';
        } else {
          if (loginEl) loginEl.style.display = '';
          if (notesEl) notesEl.style.display = 'none';
        }
      });
    })();
  </script>

  <h1>登入</h1>

  <div id="user-info"></div>

  <div class="form-group">
    <label for="email">Email:</label>
    <input type="email" id="email" placeholder="your@email.com" />
  </div>

  <div class="form-group">
    <label for="password">Password:</label>
    <input type="password" id="password" placeholder="Enter password" />
  </div>

  <div class="button-group">
    <button id="btn-signin">Email Sign-in</button>
    <button id="btn-create">Create Account</button>
    <button id="btn-reset">Password Reset</button>
  </div>

  <div class="button-group">
    <button id="btn-google">Google Sign-in</button>
    <button id="btn-signout" style="display:none;">Sign-out</button>
  </div>

  <p><a href="/upload-vocab">回到 Upload Vocabulary</a> | <a href="/notes.html">我的筆記</a></p>

  <script type="module">
    import { 
      initialize, 
      signInWithGoogle, 
      signInWithEmail,
      createAccountWithEmail,
      resetPassword,
      logout, 
      onAuthStateChanged 
    } from '/firebase-client.js';

    // Initialize Firebase
    await initialize();

    // Get DOM elements
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const btnSignin = document.getElementById('btn-signin');
    const btnCreate = document.getElementById('btn-create');
    const btnReset = document.getElementById('btn-reset');
    const btnGoogle = document.getElementById('btn-google');
    const btnSignout = document.getElementById('btn-signout');
    const userInfo = document.getElementById('user-info');

    // Auth state observer
    onAuthStateChanged(user => {
      if (user) {
        userInfo.textContent = `已登入：${user.email} (UID: ${user.uid})`;
        btnSignin.style.display = 'none';
        btnCreate.style.display = 'none';
        btnReset.style.display = 'none';
        btnGoogle.style.display = 'none';
        btnSignout.style.display = 'inline-block';
        emailInput.disabled = true;
        passwordInput.disabled = true;
      } else {
        userInfo.textContent = '未登入';
        btnSignin.style.display = 'inline-block';
        btnCreate.style.display = 'inline-block';
        btnReset.style.display = 'inline-block';
        btnGoogle.style.display = 'inline-block';
        btnSignout.style.display = 'none';
        emailInput.disabled = false;
        passwordInput.disabled = false;
      }
    });

    // Email sign-in
    btnSignin.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        alert('Please enter both email and password');
        return;
      }
      try {
        await signInWithEmail(email, password);
        alert('Sign-in successful!');
      } catch (err) {
        console.error('Sign-in error:', err);
        alert('Sign-in failed: ' + (err.message || err));
      }
    });

    // Create account
    btnCreate.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      const password = passwordInput.value;
      if (!email || !password) {
        alert('Please enter both email and password');
        return;
      }
      if (password.length < 6) {
        alert('Password must be at least 6 characters');
        return;
      }
      try {
        await createAccountWithEmail(email, password);
        alert('Account created successfully!');
      } catch (err) {
        console.error('Create account error:', err);
        alert('Failed to create account: ' + (err.message || err));
      }
    });

    // Password reset
    btnReset.addEventListener('click', async () => {
      const email = emailInput.value.trim();
      if (!email) {
        alert('Please enter your email address');
        return;
      }
      try {
        await resetPassword(email);
        alert('Password reset email sent! Check your inbox.');
      } catch (err) {
        console.error('Reset password error:', err);
        alert('Failed to send reset email: ' + (err.message || err));
      }
    });

    // Google sign-in
    btnGoogle.addEventListener('click', async () => {
      try {
        await signInWithGoogle();
      } catch (err) {
        console.error('Google sign-in error:', err);
        alert('Google sign-in failed: ' + (err.message || err));
      }
    });

    // Sign-out
    btnSignout.addEventListener('click', async () => {
      try {
        await logout();
        emailInput.value = '';
        passwordInput.value = '';
        alert('Signed out successfully');
      } catch (err) {
        console.error('Sign-out error:', err);
        alert('Sign-out failed: ' + (err.message || err));
      }
    });
  </script>
</body>
</html>
