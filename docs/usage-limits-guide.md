# 🚦 Azure AI 圖片生成使用限制指南

## 📋 概述

為了控制 Azure OpenAI DALL-E 3 的使用費用，系統已實施完整的使用量追蹤和限制機制。

## 🎯 使用限制設定

### 預設限制值

**每日限制**：
- 每用戶：5 張圖片
- 全系統：50 張圖片  
- 每日費用：$3.00

**每月限制**：
- 每用戶：30 張圖片
- 全系統：300 張圖片
- 每月費用：$30.00

### 圖片生成成本

| 規格 | 成本 (USD) |
|------|------------|
| Standard 1024x1024 | $0.040 |
| Standard 1792x1024 | $0.080 |
| Standard 1024x1792 | $0.080 |
| HD 1024x1024 | $0.080 |
| HD 1792x1024 | $0.120 |
| HD 1024x1792 | $0.120 |

## ⚙️ 環境變數配置

在 `.env` 文件中設定以下變數：

```env
# 使用量限制設定
DAILY_LIMIT_PER_USER=5          # 每用戶每日圖片數量
DAILY_LIMIT_GLOBAL=50           # 全系統每日圖片數量
MONTHLY_LIMIT_PER_USER=30       # 每用戶每月圖片數量
MONTHLY_LIMIT_GLOBAL=300        # 全系統每月圖片數量
DAILY_COST_LIMIT=3.0           # 每日費用限制 (USD)
MONTHLY_COST_LIMIT=30.0        # 每月費用限制 (USD)
```

## 🔧 系統架構

### 核心組件

1. **UsageLimiter Service** (`src/services/usage-limiter.js`)
   - 追蹤用戶和全系統使用量
   - 檢查使用限制
   - 記錄使用統計到 Firestore

2. **Azure OpenAI Service** (已整合限制檢查)
   - 生成前檢查使用限制
   - 生成後記錄使用量
   - 失敗時不計入使用量

3. **Usage Stats Routes** (`routes/usage-stats.js`)
   - 提供使用統計 API
   - 管理員功能
   - 測試模擬功能

### 資料庫結構

**Firestore 集合**: `usage_stats`

**用戶文檔** (`user_{userId}`):
```json
{
  "daily": {
    "2024-12-12": {
      "count": 3,
      "cost": 0.12
    }
  },
  "monthly": {
    "2024-12": {
      "count": 15,
      "cost": 0.60
    }
  },
  "lastUsed": "2024-12-12T10:30:00Z",
  "userId": "user123"
}
```

**全系統文檔** (`global`):
```json
{
  "daily": {
    "2024-12-12": {
      "count": 45,
      "cost": 1.80
    }
  },
  "monthly": {
    "2024-12": {
      "count": 250,
      "cost": 10.00
    }
  },
  "lastUpdated": "2024-12-12T10:30:00Z"
}
```

## 🎮 使用者體驗

### 限制檢查流程

1. **生成前檢查**：
   - 檢查用戶每日/每月限制
   - 檢查全系統每日/每月限制
   - 檢查費用限制
   - 計算預估成本

2. **限制達到時的處理**：
   - 顯示友善的錯誤訊息
   - 說明具體的限制類型
   - 建議等待時間或替代方案

3. **使用統計頁面**：
   - 即時顯示使用量和剩餘額度
   - 進度條視覺化
   - 費用追蹤
   - 全系統狀態

### 錯誤訊息範例

```
使用限制: 已達到每日個人限制 (5 張圖片)
使用限制: 系統已達到每日限制 (50 張圖片)  
使用限制: 已達到每日費用限制 ($3.00)
```

## 📊 監控和管理

### 使用統計頁面功能

- **個人統計**：今日/本月使用量和費用
- **系統統計**：全系統使用狀況
- **進度條**：視覺化剩餘額度
- **警告系統**：接近限制時的提醒

### 管理員功能

- 查看全系統使用統計
- 監控費用趨勢
- 調整限制參數

### 測試功能（開發環境）

- 模擬圖片生成使用量
- 測試限制機制
- 驗證統計準確性

## 🔒 安全機制

### 防濫用措施

1. **多層限制**：用戶級別 + 系統級別 + 費用級別
2. **實時檢查**：每次生成前都檢查限制
3. **準確記錄**：只記錄成功的生成
4. **容錯處理**：系統錯誤時不計入使用量

### 資料完整性

- 使用 Firestore 原子操作
- 防止併發問題
- 自動清理過期資料

## 🎯 Kids Vocabulary 特殊處理

Kids Vocabulary 功能已整合使用限制：

- 自動使用 Standard 品質（較低成本）
- 固定 1024x1024 尺寸
- 友善的限制提示訊息
- 不影響學習體驗的錯誤處理

## 📈 費用優化建議

### 成本控制策略

1. **優先使用 Standard 品質**：成本較 HD 低 50%
2. **選擇合適尺寸**：1024x1024 比長方形便宜
3. **設定合理限制**：根據預算調整每日/每月限制
4. **監控使用趨勢**：定期檢查統計報告

### 限制調整指南

**保守設定**（低預算）：
```env
DAILY_LIMIT_PER_USER=3
MONTHLY_LIMIT_PER_USER=20
DAILY_COST_LIMIT=2.0
MONTHLY_COST_LIMIT=20.0
```

**標準設定**（中等預算）：
```env
DAILY_LIMIT_PER_USER=5
MONTHLY_LIMIT_PER_USER=30
DAILY_COST_LIMIT=3.0
MONTHLY_COST_LIMIT=30.0
```

**寬鬆設定**（高預算）：
```env
DAILY_LIMIT_PER_USER=10
MONTHLY_LIMIT_PER_USER=50
DAILY_COST_LIMIT=5.0
MONTHLY_COST_LIMIT=50.0
```

## 🚀 部署注意事項

### 環境設定

1. 確保 Firebase Admin SDK 已正確配置
2. 設定適當的 Firestore 安全規則
3. 配置環境變數
4. 測試限制機制

### 監控建議

- 設定 Azure 費用警報
- 定期檢查使用統計
- 監控異常使用模式
- 備份使用資料

這個系統提供了完整的費用控制機制，確保 Azure AI 圖片生成功能在預算範圍內安全運行！